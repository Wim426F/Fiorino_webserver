<!DOCTYPE html>
<html>

<head>
	<title>
		Fiorino
	</title>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="style.css" type="text/css">
	<script src="pureknob.js" type="text/javascript"></script>
	<script>
		var batteryCapacity = 0;
		var batteryPercentage = 0;
		var batteryVoltage = 0;
		var batteryCurrent = 0;
		var batteryTemperature = 0;

		var cellVoltageMin = 0;
		var cellVoltageMax = 0;

		var balancedCapacity = 0;
		var balancingPower = 0;

		var chargerPwm = 0;
		var chargerPower = 0;

		var maxEvseAmps = 0;
		var maxCableAmps = 0;

		function gauges() {
			// Create knob element, 300 x 300 px in size.
			socGauge = pureknob.createKnob(250, 250);
			speedGauge = pureknob.createKnob(250, 250);

			// Set properties.
			socGauge.setProperty('angleStart', -0.75 * Math.PI);
			socGauge.setProperty('angleEnd', 0.75 * Math.PI);
			socGauge.setProperty('colorFG', '#2ecc71');
			socGauge.setProperty('colorBG', '#212121');
			socGauge.setProperty('colorLabel', '#2ecc71');
			socGauge.setProperty('trackWidth', 0.3);
			socGauge.setProperty('valMin', 0);
			socGauge.setProperty('valMax', 100);
			socGauge.setProperty('textScale', '0.8');
			socGauge.setProperty('label', 'SOC');
			socGauge.setProperty('readonly', 'true');
			socGauge.setProperty('fnValueToString', function (value) {
				let string = value.toString();
				result = string + ' %';
				return result;
			});

			speedGauge.setProperty('angleStart', -0.75 * Math.PI);
			speedGauge.setProperty('angleEnd', 0.75 * Math.PI);
			speedGauge.setProperty('colorFG', '#e67e22');
			speedGauge.setProperty('colorBG', '#212121');
			speedGauge.setProperty('colorLabel', '#e67e22');
			speedGauge.setProperty('trackWidth', 0.3);
			speedGauge.setProperty('valMin', 0);
			speedGauge.setProperty('valMax', 10);
			speedGauge.setProperty('textScale', '0.72');
			speedGauge.setProperty('label', 'Power');
			speedGauge.setProperty('needle', "true");
			speedGauge.setProperty('readonly', 'true');
			speedGauge.setProperty('fnValueToString', function (value) {
				let string = value.toString();
				result = string + ' kW';
				return result;
			});

			socGauge.setValue(0);
			speedGauge.setValue(0);

			// Create element node.
			socNode = socGauge.node();
			speedNode = speedGauge.node();

			// Add it to the DOM.
			socElem = document.getElementById('socElement');
			socElem.appendChild(socNode);

			speedElem = document.getElementById('speedElement');
			speedElem.appendChild(speedNode);

			socGauge.setValue(0);
			speedGauge.setValue(0);
		}

		function ready() {
			gauges();
			updateData();
		}
		document.addEventListener('DOMContentLoaded', ready, false);

		function updateData() {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					cellVoltageMin = parseFloat(this.responseText);
					document.getElementById("Vmin").innerHTML = cellVoltageMin;
					console.log(this.responseText);
					console.log(cellVoltageMin);
					console.log("");
				}
			};
			xhttp.open("GET", "/vmin", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					cellVoltageMax = parseFloat(this.responseText);
					document.getElementById("Vmax").innerHTML = cellVoltageMax;
					console.log(this.responseText);
					console.log(cellVoltageMax);
					console.log("");
				}
			};
			xhttp.open("GET", "/vmax", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryVoltage = parseFloat(this.responseText);
					document.getElementById("Vtot").innerHTML = batteryVoltage;
					console.log(this.responseText);
					console.log(batteryVoltage);
					console.log("");
				}
			};
			xhttp.open("GET", "/vtot", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryCurrent = Math.abs(parseFloat(this.responseText))
					document.getElementById("Ampere").innerHTML = batteryCurrent;
					console.log(this.responseText);
					console.log(batteryCurrent);
					console.log("");
				}
			};
			xhttp.open("GET", "/amps", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryCapacity = parseFloat(this.responseText);
					document.getElementById("SOC").innerHTML = batteryCapacity;
					console.log(this.responseText);
					console.log(batteryCapacity);
					console.log("");
				}
			};
			xhttp.open("GET", "/soc", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryTemperature = parseFloat(this.responseText);
					document.getElementById("Temperature").innerHTML = batteryTemperature;
					console.log(this.responseText);
					console.log(batteryTemperature);
					console.log("");
				}
			};
			xhttp.open("GET", "/temp", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryTemperature = parseFloat(this.responseText);
					document.getElementById("cableamps").innerHTML = batteryTemperature;
					console.log(this.responseText);
					console.log(batteryTemperature);
					console.log("");
				}
			};
			xhttp.open("GET", "/cableamps", true);
			xhttp.send();

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					batteryTemperature = parseFloat(this.responseText);
					document.getElementById("evseamps").innerHTML = batteryTemperature;
					console.log(this.responseText);
					console.log(batteryTemperature);
					console.log("");
				}
			};
			xhttp.open("GET", "/evseamps", true);
			xhttp.send();

			batteryPercentage = ((100 / 70 * batteryCapacity) - cellVoltageMax - cellVoltageMin) * 50;
			chargerPower = batteryVoltage * batteryCurrent / 1000;

			socGauge.setValue(batteryPercentage);
			speedGauge.setValue(chargerPower);

			console.log("batteryCapacity:");
			console.log(batteryPercentage);
			console.log("chargerPower:");
			console.log(chargerPower);
		}

		setInterval(function () {
			updateData();
		}, 4000);
	</script>
</head>

<body class="body">
	<div class="parent">
		<div id="socElement" class="knob"> </div>
		<div id="speedElement" class="knob"> </div>
		<div class="spacer"></div>
	</div>

	<div class="parent">
		<div class="knob2">
			<p class="textstyle">Vmin</p>
			<span class="display" id="Vmin"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">Vmax</p>
			<span class="display" id="Vmax"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">Vtot</p>
			<span class="display" id="Vtot"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">Ampere</p>
			<span class="display" id="Ampere"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">SOC</p>
			<span class="display" id="SOC"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">Temperature</p>
			<span class="display" id="Temperature"></span>
		</div>
	</div>

	<div class="spacer"></div>

	<div class="parent">
		<p class="titlestyle">EVSE</p>
		<div class="knob2">
			<p class="textstyle">Max EVSE<br> amps</p>
			<span class="display" id="evseamps"></span>
		</div>
		<div class="knob2">
			<p class="textstyle">Max Cable<br> amps</p>
			<span class="display" id="cableamps"></span>
		</div>
	</div>

	<div class="spacer"></div>
	<hr class="line">
	<div class="parent">
		<div class="child">
			<p class="textstyle">
				Functions
			</p>
			<div>
				<span class="button" id="datalog" onclick="window.location.href = '/datalog'">Datalog</span>
				<span class="button" id="serialport" onclick="window.location.href = '/serialport'">Serial Port</span>
			</div>
		</div>

		<div class="child">
			<p class="textstyle">
				Controller Configuration
			</p>
			<div>
				<span class="button" id="parameters" onclick="window.location.href = '/parameters'">Parameters</span>
				<span class="button" id="upload" onclick="window.location.href = '/update'">Upload</span>
			</div>
		</div>
	</div>
</body>

</html>